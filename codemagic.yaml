# codemagic.yaml
# Versão final com a flag --flavor para builds Android e iOS.

workflows:
  # ===================================================================
  # === WORKFLOW PARA O FLAVOR DE DESENVOLVIMENTO (DEV) =============
  # ===================================================================
  build-dev-flavor:
    name: 'Build DEV Flavor (Android, iOS, Web)'
    instance_type: mac_mini_m2
    max_build_duration: 60
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
          include: true
    environment:
      flutter: 3.16.0
      xcode: 16.4
      cocoapods: default
      vars:
        FLAVOR_VALUE: "DEV"
    scripts:
      - name: 'Gerar arquivo .env/dart-define-dev.json'
        script: |
          mkdir -p .env
          echo "Gerando .env/dart-define-dev.json..."
          echo "{" > .env/dart-define-dev.json
          echo '  "FLAVOR": "'$FLAVOR_VALUE'"' >> .env/dart-define-dev.json
          echo "}" >> .env/dart-define-dev.json
          echo "Conteúdo do arquivo gerado:"
          cat .env/dart-define-dev.json

      - name: 'Instalar dependências'
        script: |
          flutter packages pub get

      - name: 'Build Android (APK) - DEV'
        script: |
          flutter build apk --release \
            --flavor dev \
            --dart-define-from-file=.env/dart-define-dev.json
      
      # - name: 'Build iOS - DEV'
      #   script: |
      #     # Para iOS, a flag --flavor seleciona o "Scheme" correspondente no Xcode.
      #     # É uma boa prática garantir que você tenha um Scheme chamado 'dev'.
      #     flutter build ios --release \
      #       --flavor dev \
      #       --dart-define-from-file=.env/dart-define-dev.json

      - name: 'Build Web - DEV'
        script: |
          # IMPORTANTE: O build para Web não usa a flag --flavor.
          # A diferenciação é feita apenas pelas variáveis do dart-define.
          flutter build web --release \
            --dart-define-from-file=.env/dart-define-dev.json
    artifacts:
      - build/app/outputs/apk/release/*.apk
      - build/ios/ipa/*.ipa
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/Products/Release-iphoneos/*.app
      - build/web/**
